import { useState, useEffect } from 'react'
import FarmField from './components/FarmField'
import { 
  FarmScreen, 
  ShopScreen, 
  StatsScreen, 
  ProfileScreen 
} from '/src/components/screens/index.js'
import './App.css'

function App() {
  const [activeScreen, setActiveScreen] = useState('farm')
  const [user, setUser] = useState({
    game_data: {
      money: 740,
      level: 1,
      xp: 390,
      inventory: [],
      farm: []
    }
  })

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏
    useEffect(() => {
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp
        tg.ready()

        tg.CloudStorage.getItem('user_game_data', (error, savedData) => {
          if (!error && savedData) {
          try {
          const parsedData = JSON.parse(savedData)
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', parsedData)
          
          setUser(prev => ({
            ...prev,
            game_data: { ...prev.game_data, ...parsedData }
          }))
              } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e)
              }
            } else {
              console.log('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ')
            }
          })
        
        setTimeout(() => {
          tg.expand()
          tg.disableVerticalSwipes()
          tg.setHeaderColor('#4CAF50')
          tg.MainButton.hide()
          tg.BackButton.hide()
          
          console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
          
          // –§–∏–∫—Å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
          setTimeout(() => {
            const nav = document.querySelector('.nav-container')
            if (nav) {
              nav.style.position = 'fixed'
              nav.style.bottom = '0'
            }
          }, 200)
        }, 100)
      }
    }, [])

    const updateGameData = (newGameData) => {
      setUser(prev => ({
        ...prev,
        game_data: { ...prev.game_data, ...newGameData }
      }))

      // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Telegram Cloud
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.CloudStorage.setItem(
          'user_game_data',
          JSON.stringify(newGameData),
          (error) => {
            if (error) {
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ CloudStorage:', error)
            } else {
              console.log('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ CloudStorage')
            }
          }
        )
      }
    }

  return (
    <div className="app">
      {/* –ù–∞—à–∞ –∑–µ–ª—ë–Ω–∞—è —à–∞–ø–∫–∞ */}
      <div className="header-compact-vertical">
        <div className="header-top-row">
          <div className="header-logo-small">
            <span className="logo-emoji-small">üöú</span>
            <h1 className="app-title-small">FARM</h1>
          </div>
        </div>
        
        <div className="stats-row">
          <div className="stat-compact-horizontal">
            <span className="stat-icon">üí∞</span>
            <div className="stat-text">
              <span className="stat-label">–î–µ–Ω—å–≥–∏</span>
              <span className="stat-value">{user.game_data?.money || 0}</span>
            </div>
          </div>
          
          <div className="stat-compact-horizontal">
            <span className="stat-icon">üå±</span>
            <div className="stat-text">
              <span className="stat-label">–£—Ä–æ–≤–µ–Ω—å</span>
              <span className="stat-value">{user.game_data?.level || 1}</span>
            </div>
          </div>
          
          <div className="stat-compact-horizontal">
            <span className="stat-icon">‚≠ê</span>
            <div className="stat-text">
              <span className="stat-label">–û–ø—ã—Ç</span>
              <span className="stat-value">{user.game_data?.xp || 0}</span>
            </div>
          </div>
        </div>
      </div>

      {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
      <div className="nav-container">
        <button
          className={`nav-btn ${activeScreen === 'farm' ? 'active' : ''}`}
          onClick={() => setActiveScreen('farm')}
        >
          üåæ –§–µ—Ä–º–∞
        </button>
        <button
          className={`nav-btn ${activeScreen === 'shop' ? 'active' : ''}`}
          onClick={() => setActiveScreen('shop')}
        >
          üõí –ú–∞–≥–∞–∑–∏–Ω
        </button>
        <button
          className={`nav-btn ${activeScreen === 'profile' ? 'active' : ''}`}
          onClick={() => setActiveScreen('profile')}
        >
          üë§ –ü—Ä–æ—Ñ–∏–ª—å
        </button>
      </div>

      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
      <main className="main-content">
        {activeScreen === 'farm' && (
          <FarmField user={user} updateGameData={updateGameData} />
        )}
        {activeScreen === 'shop' && (
          <ShopScreen user={user} updateGameData={updateGameData} />
        )}
        {activeScreen === 'profile' && (
          <ProfileScreen user={user} updateGameData={updateGameData} />
        )}
      </main>
    </div>
  )
}

export default App